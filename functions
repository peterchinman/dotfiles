# Git worktree add with sibling directory convention: repo--branch
gwt() {
  if [ -z "$1" ]; then
    echo "Usage: gwt <branch> [start-point]    (creates new branch)"
    echo "       gwt -e <existing-branch>      (checkout existing branch)"
    return 1
  fi

  local root=$(git rev-parse --show-toplevel 2>/dev/null)
  if [ -z "$root" ]; then
    echo "Not in a git repository"
    return 1
  fi

  local repo=$(basename "$root")
  local parent=$(dirname "$root")

  if [ "$1" = "-e" ]; then
    local branch="$2"
    local wt_path="$parent/$repo--$branch"
    git worktree add "$wt_path" "$branch" && cd "$wt_path"
  else
    local branch="$1"
    local start_point="${2:-HEAD}"
    local wt_path="$parent/$repo--$branch"
    git worktree add -b "$branch" "$wt_path" "$start_point" && cd "$wt_path"
  fi
}

# Git worktree switch with fzf
gws() {
  local worktree=$(git worktree list | fzf --height=10 | awk '{print $1}')
  [ -n "$worktree" ] && cd "$worktree"
}

# Git worktree close: remove current worktree and cd to main
gwclose() {
  local current=$(git rev-parse --show-toplevel 2>/dev/null)
  local main=$(git worktree list | head -1 | awk '{print $1}')

  if [ "$current" = "$main" ]; then
    echo "Can't close main worktree"
    return 1
  fi

  cd "$main" && git worktree remove "$current" && rm -rf "$current"
}
